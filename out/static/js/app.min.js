angular.module("HeraldApp").controller("activityCtrl",["$scope","callApi","MessageShow","$state","$ionicScrollDelegate","$ionicLoading",function(t,e,n,c,o,a){function i(){t.show(),s(1,function(){t.hide()}),t.activity=l}function r(t,e){var n=(new Date(Date.parse(t.replace(/-/g,"/"))),new Date(Date.parse(e.replace(/-/g,"/")))),c=new Date;return c>n?"已结束":"进行中"}var l={page:1,scrollState:!0,content:[]},s=function(c,o){var a={page:c};e.getData("/huodong/get","GET",a).then(function(e){if(200!=e.code)n.MessageShow(e.content,2e3);else{var c=e.content;c.forEach(function(t){t.state=r(t.start_time,t.end_time),""==t.pic_url&&(t.pic_url="./static/img/2016-activity-advertising.jpg")}),t.activity.content=t.activity.content.concat(c),c.length<10&&(l.scrollState=!1)}"function"==typeof o&&o()})["catch"](function(t){n.MessageShow("网络错误",2e3),"function"==typeof o&&o()})};t.doRefresh=function(){t.activity.page=1,t.activity.content=[],t.activity.scrollState=!0,s(1,function(){t.$broadcast("scroll.refreshComplete"),n.MessageShow("刷新成功",2e3)})},t.addItems=function(){l.page+=1,s(l.page,function(){t.$broadcast("scroll.refreshComplete")})},t.show=function(){a.show({template:"正在加载..."})},t.hide=function(){a.hide()},t.clickDetail=function(t){""!=t&&(window.location.href=t)},i()}]);
angular.module("HeraldApp").controller("LoginCtrl",["User","$scope","$log","MessageShow","$state","$stateParams","$rootScope",function(e,r,o,a,n,t,s){r.formData={login_username:"",login_password:""};var g=s.lastState||"index.home";console.log(g);var l=function(e){return e.login_username.length<1?"用户名不能为空!":e.login_password.length<1?"密码不能为空":null};r.login=function(t){var s=l(r.formData);s?r.error_message=s:e.login(r.formData.login_username,r.formData.login_password).then(function(e){o.debug(e),e?r.error_message=e:(a.MessageShow("登录成功",1e3),n.transitionTo(g,{},{reload:!0,notify:!0}))},function(e){a.MessageShow("网络错误",1e3)})}}]).controller("registerCtrl",["User","$scope","$log","MessageShow","$state","$rootScope",function(e,r,o,a,n,t){var s=t.lastState||"index.home";r.formData={reg_username:"",pwd:"",cardnumber:"",cardpwd:""};var g=function(e){return e.reg_username.length<1?"用户名不能为空!":e.pwd.length<1?"密码不能为空":e.cardnumber.length<1?"一卡通不能为空":e.cardpwd.length<1?"一卡通密码不能为空":null};r.register=function(t){var l=g(r.formData);l?r.error_message=l:e.register(r.formData.reg_username,r.formData.pwd,r.formData.cardnumber,r.formData.cardpwd).then(function(e){o.debug(e),e?r.error_message=e:(a.MessageShow("注册成功",1e3),setTimeout(function(){n.transitionTo(s,{},{reload:!0,notify:!0})},1e3))},function(e){a.MessageShow("网络错误",1e3)})}}]);
angular.module("HeraldApp").controller("DeliverAdminLoginCtrl",["$scope","MessageShow","$state","$rootScope","DeliverAdmin",function(e,n,o,t,r){e.formData={login_username:"",login_password:""};var a="deliver.admin",i=function(e){return e.login_username.length<1?"用户名不能为空!":e.login_password.length<1?"密码不能为空":null};e.login=function(t){var s=i(e.formData);s?e.error_message=s:r.login(e.formData.login_username,e.formData.login_password).then(function(t){t?e.error_message=t:(n.MessageShow("登录成功",1e3),o.transitionTo(a,{},{reload:!0,notify:!0}))},function(e){n.MessageShow("网络错误",1e3)})}}]).controller("DeliverAdminCtrl",["$scope","callApi","DeliverAdmin","MessageShow","$rootScope","$state","$ionicLoading",function(e,n,o,t,r,a,i){function s(e,n){return n?{state:"已完成",is_operate:!1}:e&&!n?{state:"派送中",is_operate:!0,key:"finish",value:!0,name:"派送完成"}:e||n?{state:"未知",is_operate:!1}:{state:"未接单",is_operate:!0,key:"receiving",value:!0,name:"我要接单"}}function c(){l.token?(e.show(),d(1,function(){e.hide()})):(t.MessageShow("请先登录",1e3),a.go("deliver.admin_login"))}var l=o.getCurrentUser(),g={page:1,scrollState:!0,content:[],no_content:!1};e.order=g;var d=function(r,i){var c={page:r};n.getData("/deliver/admin_query","POST",c,{Expressadmin:o.getCurrentUser().token}).then(function(n){if(200!=n.code)302==n.code?(t.MessageShow("请先登录",1e3),a.go("deliver.admin_login")):t.MessageShow(n.content,2e3);else{var o=n.content;o.forEach(function(e){e.state=s(e.receiving,e.finish)}),e.order.content=e.order.content.concat(o),o.length<10&&(e.order.scrollState=!1)}0===e.order.content.length?e.order.no_content=!0:e.order.no_content=!1,"function"==typeof i&&i(n.code)})["catch"](function(e){t.MessageShow("网络错误",2e3),"function"==typeof i&&i()})};e.doRefresh=function(){e.order.page=1,e.order.content=[],e.order.scrollState=!0,d(1,function(n){e.$broadcast("scroll.refreshComplete"),200==n&&t.MessageShow("刷新成功",2e3)})},e.show=function(){i.show({template:"正在加载..."})},e.hide=function(){i.hide()},e.changeState=function(e){var r={id:e.id,key:e.state.key,state:e.state.value};n.getData("/deliver/change","POST",r,{Expressadmin:o.getCurrentUser().token}).then(function(n){if(200!=n.code)302==n.code?(t.MessageShow("请先登录",1e3),a.go("deliver.admin_login")):t.MessageShow(n.content,2e3);else{t.MessageShow("操作成功",2e3);var o=e.state.key;"finish"===o?e.state=s(!0,!0):"receiving"===o&&(e.state=s(!1,!0))}})["catch"](function(e){t.MessageShow("网络错误",2e3),"function"==typeof callback&&callback()})},c()}]);
angular.module("HeraldApp").controller("DeliverCtrl",["$scope","callApi","MessageShow","$ionicLoading","User","$state","$rootScope",function(e,o,t,n,r,a,c){function i(e,o){return o?"已完成":e&&!o?"派送中":e||o?"未知":"未接单"}function s(){e.height=.75*window.screen.height,h.token?(e.show(),g(1,function(){e.hide()})):(t.MessageShow("请先登录",1e3),a.go("login"))}var l={page:1,scrollState:!0,content:[],no_content:!1};e.order=l;var h=r.getCurrentUser(),g=function(n,r){var s={page:n};o.getData("/deliver/query","POST",s,h.token).then(function(o){if(200!=o.code)302==o.code?(t.MessageShow("请先登录",1e3),c.lastState="deliver.home",a.go("login")):t.MessageShow(o.content,2e3);else{var n=o.content;n.forEach(function(e){e.state=i(e.receiving,e.finish),"未接单"===e.state&&(e.cancel=!0)}),e.order.content=e.order.content.concat(n),n.length<10&&(e.order.scrollState=!1)}0===e.order.content.length?e.order.no_content=!0:e.order.no_content=!1,"function"==typeof r&&r(o.code)})["catch"](function(e){t.MessageShow("网络错误",2e3),"function"==typeof r&&r()})};e.doRefresh=function(){e.order.page=1,e.order.content=[],e.order.scrollState=!0,g(1,function(o){e.$broadcast("scroll.refreshComplete"),200==o&&t.MessageShow("刷新成功",2e3)})},e.addItems=function(){l.page+=1,g(l.page,function(){e.$broadcast("scroll.refreshComplete")})},e.show=function(){n.show({template:"正在加载..."})},e.hide=function(){n.hide()},e.cancel=function(n){var r={id:n};o.getData("/deliver/delete","POST",r,h.token).then(function(o){if(200!=o.code)302==o.code?(c.lastState="deliver.home",a.go("login")):t.MessageShow(o.content,2e3);else{t.MessageShow("取消成功",2e3);var r=e.order.content;r.forEach(function(e,o){if(e.id===n)return void r.splice(o,1)})}})["catch"](function(e){t.MessageShow("网络错误",2e3)})},s()}]).controller("DeliverPostCtrl",["$scope","callApi","MessageShow","$ionicLoading","User","$state","$rootScope",function(e,o,t,n,r,a,c){var i=r.getCurrentUser();e.info={name:"",sms:"",phone:"",location:0,arrival:0,weight:0,dest:0};var s={location:["东门","南门"],arrival:["12:20~12:40","17:40~18:00"],weight:["2kg以下","2~4kg","4kg以上"],dest:["梅九大厅","梅三四大厅"]};e.show_info=s,e.select=function(o,t){e.info[o]=t},e.submit=function(){var n=e.info;if(n.name.length<1||n.sms.length<1||n.phone.length<1)alert("信息不能为空");else{var r={user_name:n.name,dest:s.dest[n.dest],sms_txt:n.sms,arrival:s.arrival[n.arrival],locate:s.location[n.location],weight:s.weight[n.weight],phone:n.phone};o.getData("/deliver/submit","POST",r,i.token).then(function(e){200!=e.code?302==e.code?(c.lastState="deliver.home",a.go("login")):t.MessageShow(e.content,2e3):(t.MessageShow("提交成功",2e3),a.go("deliver.home"))})["catch"](function(e){t.MessageShow("网络错误",2e3)})}}}]);
angular.module("HeraldApp").controller("yuyueBeforeCtrl",["$state","User","$rootScope","MessageShow",function(e,t,o,n){var r=t.getCurrentUser();r.token?o.user=r:(n.MessageShow("请先登录",1e3),o.lastState="yuyue.home",e.go("login"))}]).controller("yuyueCtrl",["$scope","callApi","$ionicLoading","User","MessageShow","$http","$state","yuyueService","$rootScope",function(e,t,o,n,r,a,u,s,d){function l(){!e.dateInfo&&y.token&&g()}var c={getDateUrl:{url:"http://yuyue.seu.edu.cn/eduplus/phoneOrder/initOrderIndexP.do?sclId=1",method:"GET"},myOrderUrl:{url:"http://yuyue.seu.edu.cn/eduplus/phoneOrder/fetchMyOrdersP.do?sclId=1",method:"GET"},getOrderInfoUrl:{url:"http://yuyue.seu.edu.cn/eduplus/phoneOrder/phoneOrder/getOrderInfoP.do",method:"GET"},judgeOrderUrl:{url:"http://yuyue.seu.edu.cn/eduplus/phoneOrder/judgeOrderP.do",method:"GET"},getPhoneUrl:{url:"http://yuyue.seu.edu.cn/eduplus/phoneOrder/initEditOrderP.do?sclId=1",method:"GET"}},h={7:{name:"乒乓球"},8:{name:"篮球"},9:{name:"排球"},10:{name:"羽毛球"},11:{name:"舞蹈"},12:{name:"健身"},13:{name:"武术"},14:{name:"跆拳道"}};e.typeInfo=h;var m=function(e){var t={url:c[e].url,method:c[e].method};return t},y=n.getCurrentUser(),g=function(){var e=m("getDateUrl");t.getData("/yuyue","POST",e,y.token).then(function(e){200!=e.code?401==e.code?(d.lastState="yuyue.home",u.go("login")):r.MessageShow(e.content,2e3):f(e.content)},function(e){r.MessageShow("网络错误",2e3)})},f=function(t){var o={today:{dayInfo:t.timeList[0].dayInfo.split(" ")[0],weekInfo:t.timeList[0].dayInfo.split(" ")[1]},tomorrow:{dayInfo:t.timeList[1].dayInfo.split(" ")[0],weekInfo:t.timeList[1].dayInfo.split(" ")[1]},afterTomo:{dayInfo:t.timeList[2].dayInfo.split(" ")[0],weekInfo:t.timeList[2].dayInfo.split(" ")[1]}};e.dateInfo=o},p=!0,S=function(o,n){!U[n][o]&&p&&(p=!1,r.MessageShow("正在加载",1e4),data=m("getOrderInfoUrl"),data.data={sclId:1,itemId:o,dayInfo:e.dateInfo[n].dayInfo},t.getData("/yuyue","POST",data,y.token).then(function(e){200!=e.code?401==e.code?(d.lastState="yuyue.home",u.go("login")):r.MessageShow(e.content,2e3):I(o,n,e.content)},function(e){r.MessageShow("网络错误",2e3)}))},U={today:{},tomorrow:{},afterTomo:{}};e.orderInfo=U;var I=function(e,t,o){U[t][e]||(U[t][e]=[]);for(i in o.orderIndexs){var n={used:o.orderIndexs[i].usedSite,all:o.orderIndexs[i].allSite,avaliTime:o.orderIndexs[i].avaliableTime,enable:o.orderIndexs[i].enable};U[t][e].push(n)}r.hide(),p=!0},M={today:{},tomorrow:{},afterTomo:{}};e.toggleGroup=function(e,t){M[e][t]=M[e][t]|!1,M[e][t]=!M[e][t],M[e][t]&&S(t,e)},e.isToggleGroup=function(e,t){return M[e][t]},e.newOrder=function(t,o,n){var r=e.dateInfo[o].dayInfo;w(t,r,n)};var w=function(e,o,n){var a=m("judgeOrderUrl");a.data={sclId:1,itemId:e,dayInfo:o,time:n},t.getData("/yuyue","POST",a,y.token).then(function(t){200!=t.code?401==t.code?(d.lastState="yuyue.home",u.go("login")):r.MessageShow(t.content,2e3):0!=t.content.code?r.MessageShow(t.content.msg,2e3):(s.setInfo(h[e].name,e,n,o,t.content),O())},function(e){r.MessageShow("网络错误",2e3)})},O=function(){var e=m("getPhoneUrl");t.getData("/yuyue","POST",e,y.token).then(function(e){200!=e.code?r.MessageShow(e.content,2e3):(s.setPhone(e.content.phone),u.go("yuyue-new"))},function(){r.MessageShow("网络错误",2e3)})};l()}]).controller("yuyueNewCtrl",["$scope","yuyueService","callApi","MessageShow","User","$ionicModal","$sce",function(e,t,o,n,r,a,u){function s(){U(),1==l.data.item.allowHalf?(i.allGround=[{id:1,name:"全场"},{id:2,name:"半场"}],i.max={1:l.data.item.fullMaxUsers,2:l.data.item.halfMaxUsers},i.min={1:l.data.item.fullMinUsers,2:l.data.item.halfMinUsers}):(i.allGround=[{id:2,name:"半场"}],i.max={2:l.data.item.fullMaxUsers},i.min={2:l.data.item.fullMinUsers}),i.MySelect=i.allGround[0].id,a.fromTemplateUrl("addFriend.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.modal=t})}var d,l=t.getInfo(),c={myOrderUrl:{url:"http://yuyue.seu.edu.cn/eduplus/phoneOrder/fetchMyOrdersP.do?sclId=1",method:"GET"},validateImgUrl:{url:"http://yuyue.seu.edu.cn/eduplus/control/validateimage",method:"GET"},getFriendList:{url:"http://yuyue.seu.edu.cn/eduplus/order/order/order/order/searchUser.do?sclId=1",method:"POST"},newUrl:{url:"http://yuyue.seu.edu.cn/eduplus/phoneOrder/insertOredrP.do",method:"GET"}},i={allUserNum:0,allUser:[],allUserString:"",searchUser:[],searchCardnum:""};e.yuyueInfo=l,e.groundInfo=i;var h=function(e){i.allUser.pop(e)};e.removeUser=h;var m=function(e){i.allUser.push(e),e.state=!1};e.newUser=m;var y=function(){var e=encodeURIComponent(i.searchCardnum),t={url:c.getFriendList.url,method:c.getFriendList.method,data:{cardNo:e}};o.getData("/yuyue","POST",t,d.token).then(function(t){200!=t.code?401==t.code?($rootScope.lastState="yuyue.home",$state.go("login")):n.MessageShow(t.content,2e3):g(e,t.content)},function(){n.MessageShow("网络错误",2e3)})},g=function(e,t){if(i.searchUser=[],t.length<1)n.MessageShow("没有搜索到该用户",1e3);else for(var o=0;o<t.length;o++){var r={cardnum:e,name:t[o].nameDepartment,userId:t[o].userId,state:!0};i.searchUser.push(r)}};e.searchUser=y;var f=function(){i.allUserNum=i.allUser.length,i.allUserString="";for(var t=0;t<i.allUser.length;t++)i.allUserString+=i.allUser[t].name+"</br>";i.allUserString=u.trustAsHtml(i.allUserString),e.modal.hide()};e.completeAddUser=f;var p=function(){l.phone&&11==l.phone.length?i.allUserNum+1<i.min[i.MySelect]||i.allUserNum+1>i.max[i.MySelect]?n.MessageShow("人数不合法",1e3):S():n.MessageShow("手机号不合法",1e3)};e.judegInfo=p;var S=function(){var t={"orderVO.useMode":e.groundInfo.MySelect,sclId:1,"orderVO.useTime":l.day+" "+l.time,"orderVO.itemId":l.id,"orderVO.phone":l.phone,"orderVO.remark":""},r=c.newUrl.url+"?",a=0;for(var u in t)0==a?(r+=u+"="+t[u],a=1):r+="&"+u+"="+encodeURIComponent(t[u]);r+="&useUserIds=";for(var u=0;u<i.allUserNum;u++)r+=i.allUser[u].userId+",";var s={url:r,method:c.newUrl.method};o.getData("/yuyue","POST",s,d.token).then(function(e){200==e.code?401==e.code?($rootScope.lastState="yuyue.home",$state.go("login")):n.MessageShow(e.content.msg,2e3):n.MessageShow(e.content,2e3)},function(){n.MessageShow("网络错误",2e3)})},U=function(){d=r.getCurrentUser(),d.token||(n.MessageShow("请先登录",1e3),$rootScope.lastState="yuyue-new",$state.go("login"))};s()}]).controller("yuyueMyCtrl",["$scope","callApi","Storage","User","MessageShow",function(e,t,o,n,r){function a(){var e={url:d.myOrderUrl.url,method:d.myOrderUrl.method};t.getData("/yuyue","POST",e,l.token).then(function(e){200!=e.code?401==e.code?($rootScope.lastState="yuyue.home",$state.go("login")):r.MessageShow(e.content,2e3):u(e)},function(e){r.MessageShow("网络错误",2e3)})}function u(t){e.Myorder=t}function s(){e.Myorder||a()}var d={myOrderUrl:{url:"http://yuyue.seu.edu.cn/eduplus/phoneOrder/fetchMyOrdersP.do?sclId=1",method:"GET"},cancelUrl:{url:"http://yuyue.seu.edu.cn/eduplus/phoneOrder/delOrderP.do?sclId=1",method:"GET"}},l=n.getCurrentUser(),c=function(e){var o={url:d.cancelUrl.url+"&id="+e,method:d.cancelUrl.method};console.log("cancel id:"+e),t.getData("/yuyue","POST",o,l.token).then(function(e){200!=e.code?r.MessageShow(e.content,2e3):"success"==e.content.msg?(r.MessageShow("取消成功",2e3),a()):r.MessageShow(e.content.msg,2e3)},function(){r.MessageShow("网络错误",2e3)})};e.cancelOrder=c,e.stateContent={4:"通过",6:"取消",2:"完成"},s()}]);