angular.module("HeraldApp",["ionic","HeraldApp.config","HeraldApp.services"]).config(["$stateProvider","$urlRouterProvider","$ionicConfigProvider",function(e,t,l){e.state("index",{url:"/herald","abstract":!0,templateUrl:"pages/index/menu.html"}).state("index.home",{url:"/home",views:{home:{templateUrl:"pages/index/home.html",controller:"HomeCtrl"}}}).state("index.state2",{url:"/state2",views:{home:{templateUrl:"pages/index/state2.html",controller:"MyCtrl"}}}).state("login",{url:"/login",templateUrl:"pages/auth/login.html",controller:"LoginCtrl"}).state("register",{url:"/register",templateUrl:"pages/auth/register.html",controller:"registerCtrl"}).state("activity",{url:"/activity",templateUrl:"pages/activity/activity.html",controller:"activityCtrl"}).state("yuyue",{url:"/yuyue",cache:!1,"abstract":!0,templateUrl:"pages/yuyue/menu.html",controller:"yuyueBeforeCtrl"}).state("yuyue.home",{url:"/home",views:{"yuyue-home":{templateUrl:"pages/yuyue/home.html",controller:"yuyueCtrl"}}}).state("yuyue-new",{url:"/yuyue/new",cache:!1,templateUrl:"pages/yuyue/new.html",controller:"yuyueNewCtrl"}).state("yuyue.My",{url:"/my",views:{"yuyue-my":{templateUrl:"pages/yuyue/my.html",controller:"yuyueMyCtrl"}}}),t.otherwise("/herald/home")}]).controller("MyCtrl",["$scope","$state",function(e,t){}]);
angular.module("HeraldApp.config",[]).constant("ENV",{name:"production",debug:!0,version:"1.0.0",api:"http://115.28.27.150/herald/api/v1"}).config(["$ionicConfigProvider",function(o){o.tabs.position("bottom")}]);
angular.module("HeraldApp").controller("HomeCtrl",["$scope","callApi",function(i,t){i.slide_item=[{slideimg:"./static/img/2016-recuit.jpg"},{slideimg:"./static/img/2016-activity-advertising.jpg"}]}]);
angular.module("HeraldApp").directive("helloWorld",function(){return{restrict:"AE",template:"<h3>hello world</h3>",replae:!0}});
angular.module("HeraldApp.services",[]).service("Storage",["ENV",function(e){this.set=function(e,t){return window.localStorage.setItem(e,window.JSON.stringify(t))},this.get=function(e){return window.JSON.parse(window.localStorage.getItem(e))},this.remove=function(e){return window.localStorage.removeItem(e)}}]).service("User",["Storage","callApi","$q","$log",function(e,t,n,r){var o="user",i=e.get(o)||{};r.debug("service start"),this.login=function(r,s){return data={user_phone:r,password:s},loginDefer=n.defer(),t.getData("/auth/login","POST",data).then(function(t){200==t.code?(i.token=t.content,e.set(o,i),loginDefer.resolve(null)):loginDefer.resolve(t.content)},function(e){loginDefer.reject(e)}),loginDefer.promise},this.register=function(r,s,a,c){return data={phone:r,password:s,cardnumber:a,card_password:c},registerDefer=n.defer(),t.getData("/auth/reg","POST",data).then(function(t){200==t.code?(i.token=t.content,e.set(o,i),registerDefer.resolve(null)):registerDefer.resolve(t.content)},function(e){registerDefer.reject(e)}),registerDefer.promise},this.logout=function(){e.remove(o)};this.getCurrentUser=function(){return i},this.checkUser=function(){}}]).service("MessageShow",["$ionicLoading",function(e){this.errorShow=function(t){e.show({template:t,noBackdrop:!0,duration:2e3})},this.MessageShow=function(t,n){var n=2e3|n;e.show({template:t,noBackdrop:!0,duration:n})},this.show=function(t){e.show({template:t,noBackdrop:!0})},this.hide=function(){e.hide()}}]).service("yuyueService",["$http",function(e){var t={name:"健身",id:"12",time:"19:00-20:00",day:"2015-12-18",phone:"",data:{code:0,item:{allowHalf:0,fullMaxUsers:1,fullMinUsers:1,halfMaxUsers:1,halfMinUsers:1}}};this.getInfo=function(){return t},this.setInfo=function(e,n,r,o,i){t.name=e,t.id=n,t.time=r,t.day=o,t.data=i},this.setPhone=function(e){t.phone=e}}]).service("callApi",["$http","ENV","$q","$log",function(e,t,n,r){var o=1;this.namedata=function(){return o},this.getData=function(r,o,i,s,a){var c=n.defer(),u=t.api+r;i=i||null,a=a||null;var f={method:o,url:u,headers:{token:s},timeout:1e4};return"GET"==o?f.params=i:"POST"==o&&(a||(f.transformRequest=function(e){var t=[];for(var n in e)"data"!=n?t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n])):t.push(encodeURIComponent(n)+"="+JSON.stringify(e[n]));return t.join("&")}),f.headers["Content-Type"]="application/x-www-form-urlencoded",f.data=i),e(f).success(function(e){c.resolve(e)}).error(function(e,t,n){c.reject(e)}),c.promise}}]);
angular.module("todo",["ionic"]).factory("Projects",function(){return{all:function(){var t=window.localStorage.projects;return t?angular.fromJson(t):[]},save:function(t){window.localStorage.projects=angular.toJson(t)},newProject:function(t){return{title:t,tasks:[]}},getLastActiveIndex:function(){return parseInt(window.localStorage.lastActiveProject)||0},setLastActiveIndex:function(t){window.localStorage.lastActiveProject=t}}}).controller("TodoCtrl",["$scope","$timeout","$ionicModal","Projects","$ionicSideMenuDelegate",function(t,e,o,c,n){var r=function(e){var o=c.newProject(e);t.projects.push(o),c.save(t.projects),t.selectProject(o,t.projects.length-1)};t.projects=c.all(),t.activeProject=t.projects[c.getLastActiveIndex()],t.newProject=function(){var t=prompt("Project name");t&&r(t)},t.selectProject=function(e,o){t.activeProject=e,c.setLastActiveIndex(o),n.toggleLeft(!1)},o.fromTemplateUrl("new-task.html",function(e){t.taskModal=e},{scope:t}),t.createTask=function(e){t.activeProject&&e&&(t.activeProject.tasks.push({title:e.title}),t.taskModal.hide(),c.save(t.projects),e.title="")},t.newTask=function(){t.taskModal.show()},t.closeNewTask=function(){t.taskModal.hide()},t.toggleProjects=function(){n.toggleLeft()},e(function(){if(0==t.projects.length)for(;;){var e=prompt("Your first project title:");if(e){r(e);break}}})}]);
angular.module("HeraldApp").controller("activityCtrl",["$scope","callApi","MessageShow","$state","$ionicScrollDelegate","$ionicLoading",function(t,e,n,c,o,a){function i(){t.show(),s(1,function(){t.hide()}),t.activity=l}function r(t,e){var n=(new Date(Date.parse(t.replace(/-/g,"/"))),new Date(Date.parse(e.replace(/-/g,"/")))),c=new Date;return c>n?"已结束":"进行中"}var l={page:1,scrollState:!0,content:[]},s=function(c,o){var a={page:c};e.getData("/huodong/get","GET",a).then(function(e){if(200!=e.code)n.MessageShow(e.content,2e3);else{var c=e.content;c.forEach(function(t){t.state=r(t.start_time,t.end_time),""==t.pic_url&&(t.pic_url="./static/img/2016-activity-advertising.jpg")}),t.activity.content=t.activity.content.concat(c),c.length<10&&(l.scrollState=!1)}"function"==typeof o&&o()})["catch"](function(t){n.MessageShow("网络错误",2e3),"function"==typeof o&&o()})};t.doRefresh=function(){t.activity.page=1,t.activity.content=[],t.activity.scrollState=!0,s(1,function(){t.$broadcast("scroll.refreshComplete"),n.MessageShow("刷新成功",2e3)})},t.addItems=function(){l.page+=1,s(l.page,function(){t.$broadcast("scroll.refreshComplete")})},t.show=function(){a.show({template:"正在加载..."})},t.hide=function(){a.hide()},t.clickDetail=function(t){""!=t&&(window.location.href=t)},i()}]);
angular.module("HeraldApp").controller("LoginCtrl",["User","$scope","$log","MessageShow","$state","$stateParams","$rootScope",function(e,r,o,a,n,t,s){r.formData={login_username:"",login_password:""};var g=s.lastState||"index.home";console.log(g);var l=function(e){return e.login_username.length<1?"用户名不能为空!":e.login_password.length<1?"密码不能为空":null};r.login=function(t){var s=l(r.formData);s?r.error_message=s:e.login(r.formData.login_username,r.formData.login_password).then(function(e){o.debug(e),e?r.error_message=e:(a.MessageShow("登录成功",1e3),n.transitionTo(g,{},{reload:!0,notify:!0}))},function(e){a.MessageShow("网络错误",1e3)})}}]).controller("registerCtrl",["User","$scope","$log","MessageShow","$state","$rootScope",function(e,r,o,a,n,t){var s=t.lastState||"index.home";r.formData={reg_username:"",pwd:"",cardnumber:"",cardpwd:""};var g=function(e){return e.reg_username.length<1?"用户名不能为空!":e.pwd.length<1?"密码不能为空":e.cardnumber.length<1?"一卡通不能为空":e.cardpwd.length<1?"一卡通密码不能为空":null};r.register=function(t){var l=g(r.formData);l?r.error_message=l:e.register(r.formData.reg_username,r.formData.pwd,r.formData.cardnumber,r.formData.cardpwd).then(function(e){o.debug(e),e?r.error_message=e:(a.MessageShow("注册成功",1e3),setTimeout(function(){n.transitionTo(s,{},{reload:!0,notify:!0})},1e3))},function(e){a.MessageShow("网络错误",1e3)})}}]);
angular.module("HeraldApp").controller("yuyueBeforeCtrl",["$state","User","$rootScope","MessageShow",function(e,t,o,n){var r=t.getCurrentUser();r.token?o.user=r:(n.MessageShow("请先登录",1e3),o.lastState="yuyue.home",e.go("login"))}]).controller("yuyueCtrl",["$scope","callApi","$ionicLoading","User","MessageShow","$http","$state","yuyueService","$rootScope",function(e,t,o,n,r,a,u,s,d){function l(){!e.dateInfo&&y.token&&g()}var c={getDateUrl:{url:"http://yuyue.seu.edu.cn/eduplus/phoneOrder/initOrderIndexP.do?sclId=1",method:"GET"},myOrderUrl:{url:"http://yuyue.seu.edu.cn/eduplus/phoneOrder/fetchMyOrdersP.do?sclId=1",method:"GET"},getOrderInfoUrl:{url:"http://yuyue.seu.edu.cn/eduplus/phoneOrder/phoneOrder/getOrderInfoP.do",method:"GET"},judgeOrderUrl:{url:"http://yuyue.seu.edu.cn/eduplus/phoneOrder/judgeOrderP.do",method:"GET"},getPhoneUrl:{url:"http://yuyue.seu.edu.cn/eduplus/phoneOrder/initEditOrderP.do?sclId=1",method:"GET"}},h={7:{name:"乒乓球"},8:{name:"篮球"},9:{name:"排球"},10:{name:"羽毛球"},11:{name:"舞蹈"},12:{name:"健身"},13:{name:"武术"},14:{name:"跆拳道"}};e.typeInfo=h;var m=function(e){var t={url:c[e].url,method:c[e].method};return t},y=n.getCurrentUser(),g=function(){var e=m("getDateUrl");t.getData("/yuyue","POST",e,y.token).then(function(e){200!=e.code?401==e.code?(d.lastState="yuyue.home",u.go("login")):r.MessageShow(e.content,2e3):f(e.content)},function(e){r.MessageShow("网络错误",2e3)})},f=function(t){var o={today:{dayInfo:t.timeList[0].dayInfo.split(" ")[0],weekInfo:t.timeList[0].dayInfo.split(" ")[1]},tomorrow:{dayInfo:t.timeList[1].dayInfo.split(" ")[0],weekInfo:t.timeList[1].dayInfo.split(" ")[1]},afterTomo:{dayInfo:t.timeList[2].dayInfo.split(" ")[0],weekInfo:t.timeList[2].dayInfo.split(" ")[1]}};e.dateInfo=o},p=!0,S=function(o,n){!U[n][o]&&p&&(p=!1,r.MessageShow("正在加载",1e4),data=m("getOrderInfoUrl"),data.data={sclId:1,itemId:o,dayInfo:e.dateInfo[n].dayInfo},t.getData("/yuyue","POST",data,y.token).then(function(e){200!=e.code?401==e.code?(d.lastState="yuyue.home",u.go("login")):r.MessageShow(e.content,2e3):I(o,n,e.content)},function(e){r.MessageShow("网络错误",2e3)}))},U={today:{},tomorrow:{},afterTomo:{}};e.orderInfo=U;var I=function(e,t,o){U[t][e]||(U[t][e]=[]);for(i in o.orderIndexs){var n={used:o.orderIndexs[i].usedSite,all:o.orderIndexs[i].allSite,avaliTime:o.orderIndexs[i].avaliableTime,enable:o.orderIndexs[i].enable};U[t][e].push(n)}r.hide(),p=!0},M={today:{},tomorrow:{},afterTomo:{}};e.toggleGroup=function(e,t){M[e][t]=M[e][t]|!1,M[e][t]=!M[e][t],M[e][t]&&S(t,e)},e.isToggleGroup=function(e,t){return M[e][t]},e.newOrder=function(t,o,n){var r=e.dateInfo[o].dayInfo;w(t,r,n)};var w=function(e,o,n){var a=m("judgeOrderUrl");a.data={sclId:1,itemId:e,dayInfo:o,time:n},t.getData("/yuyue","POST",a,y.token).then(function(t){200!=t.code?401==t.code?(d.lastState="yuyue.home",u.go("login")):r.MessageShow(t.content,2e3):0!=t.content.code?r.MessageShow(t.content.msg,2e3):(s.setInfo(h[e].name,e,n,o,t.content),O())},function(e){r.MessageShow("网络错误",2e3)})},O=function(){var e=m("getPhoneUrl");t.getData("/yuyue","POST",e,y.token).then(function(e){200!=e.code?r.MessageShow(e.content,2e3):(s.setPhone(e.content.phone),u.go("yuyue-new"))},function(){r.MessageShow("网络错误",2e3)})};l()}]).controller("yuyueNewCtrl",["$scope","yuyueService","callApi","MessageShow","User","$ionicModal","$sce",function(e,t,o,n,r,a,u){function s(){U(),1==l.data.item.allowHalf?(i.allGround=[{id:1,name:"全场"},{id:2,name:"半场"}],i.max={1:l.data.item.fullMaxUsers,2:l.data.item.halfMaxUsers},i.min={1:l.data.item.fullMinUsers,2:l.data.item.halfMinUsers}):(i.allGround=[{id:2,name:"半场"}],i.max={2:l.data.item.fullMaxUsers},i.min={2:l.data.item.fullMinUsers}),i.MySelect=i.allGround[0].id,a.fromTemplateUrl("addFriend.html",{scope:e,animation:"slide-in-up"}).then(function(t){e.modal=t})}var d,l=t.getInfo(),c={myOrderUrl:{url:"http://yuyue.seu.edu.cn/eduplus/phoneOrder/fetchMyOrdersP.do?sclId=1",method:"GET"},validateImgUrl:{url:"http://yuyue.seu.edu.cn/eduplus/control/validateimage",method:"GET"},getFriendList:{url:"http://yuyue.seu.edu.cn/eduplus/order/order/order/order/searchUser.do?sclId=1",method:"POST"},newUrl:{url:"http://yuyue.seu.edu.cn/eduplus/phoneOrder/insertOredrP.do",method:"GET"}},i={allUserNum:0,allUser:[],allUserString:"",searchUser:[],searchCardnum:""};e.yuyueInfo=l,e.groundInfo=i;var h=function(e){i.allUser.pop(e)};e.removeUser=h;var m=function(e){i.allUser.push(e),e.state=!1};e.newUser=m;var y=function(){var e=encodeURIComponent(i.searchCardnum),t={url:c.getFriendList.url,method:c.getFriendList.method,data:{cardNo:e}};o.getData("/yuyue","POST",t,d.token).then(function(t){200!=t.code?401==t.code?($rootScope.lastState="yuyue.home",$state.go("login")):n.MessageShow(t.content,2e3):g(e,t.content)},function(){n.MessageShow("网络错误",2e3)})},g=function(e,t){if(i.searchUser=[],t.length<1)n.MessageShow("没有搜索到该用户",1e3);else for(var o=0;o<t.length;o++){var r={cardnum:e,name:t[o].nameDepartment,userId:t[o].userId,state:!0};i.searchUser.push(r)}};e.searchUser=y;var f=function(){i.allUserNum=i.allUser.length,i.allUserString="";for(var t=0;t<i.allUser.length;t++)i.allUserString+=i.allUser[t].name+"</br>";i.allUserString=u.trustAsHtml(i.allUserString),e.modal.hide()};e.completeAddUser=f;var p=function(){l.phone&&11==l.phone.length?i.allUserNum+1<i.min[i.MySelect]||i.allUserNum+1>i.max[i.MySelect]?n.MessageShow("人数不合法",1e3):S():n.MessageShow("手机号不合法",1e3)};e.judegInfo=p;var S=function(){var t={"orderVO.useMode":e.groundInfo.MySelect,sclId:1,"orderVO.useTime":l.day+" "+l.time,"orderVO.itemId":l.id,"orderVO.phone":l.phone,"orderVO.remark":""},r=c.newUrl.url+"?",a=0;for(var u in t)0==a?(r+=u+"="+t[u],a=1):r+="&"+u+"="+encodeURIComponent(t[u]);r+="&useUserIds=";for(var u=0;u<i.allUserNum;u++)r+=i.allUser[u].userId+",";var s={url:r,method:c.newUrl.method};o.getData("/yuyue","POST",s,d.token).then(function(e){200==e.code?401==e.code?($rootScope.lastState="yuyue.home",$state.go("login")):n.MessageShow(e.content.msg,2e3):n.MessageShow(e.content,2e3)},function(){n.MessageShow("网络错误",2e3)})},U=function(){d=r.getCurrentUser(),d.token||(n.MessageShow("请先登录",1e3),$rootScope.lastState="yuyue-new",$state.go("login"))};s()}]).controller("yuyueMyCtrl",["$scope","callApi","Storage","User","MessageShow",function(e,t,o,n,r){function a(){var e={url:d.myOrderUrl.url,method:d.myOrderUrl.method};t.getData("/yuyue","POST",e,l.token).then(function(e){200!=e.code?401==e.code?($rootScope.lastState="yuyue.home",$state.go("login")):r.MessageShow(e.content,2e3):u(e)},function(e){r.MessageShow("网络错误",2e3)})}function u(t){e.Myorder=t}function s(){e.Myorder||a()}var d={myOrderUrl:{url:"http://yuyue.seu.edu.cn/eduplus/phoneOrder/fetchMyOrdersP.do?sclId=1",method:"GET"},cancelUrl:{url:"http://yuyue.seu.edu.cn/eduplus/phoneOrder/delOrderP.do?sclId=1",method:"GET"}},l=n.getCurrentUser(),c=function(e){var o={url:d.cancelUrl.url+"&id="+e,method:d.cancelUrl.method};console.log("cancel id:"+e),t.getData("/yuyue","POST",o,l.token).then(function(e){200!=e.code?r.MessageShow(e.content,2e3):"success"==e.content.msg?(r.MessageShow("取消成功",2e3),a()):r.MessageShow(e.content.msg,2e3)},function(){r.MessageShow("网络错误",2e3)})};e.cancelOrder=c,e.stateContent={4:"通过",6:"取消",2:"完成"},s()}]);